# Диаграммы потоков авторизации

## 1. Вход через WhatsApp OTP (существующий)

```
┌─────────┐
│ Клиент  │
└────┬────┘
     │
     │ 1. POST /auth/send-otp/
     │    {phone_number}
     ▼
┌─────────────┐
│   Backend   │──────► Green-API ──────► WhatsApp
└──────┬──────┘                              │
       │                                     │
       │ 2. OTP код сохранен                 │
       │                                     │
       │ ◄───────────────────────────────────┘
       │    Пользователь получает код
       │
       │ 3. POST /auth/verify-otp/
       │    {phone_number, code}
       ▼
┌─────────────┐
│   Backend   │
│  - Проверка │
│  - Создание │
│    user     │
│  - Генерация│
│    JWT      │
└──────┬──────┘
       │
       │ 4. {user, tokens}
       ▼
┌─────────┐
│ Клиент  │──► Сохранение в localStorage
└─────────┘    Переход на /dashboard
```

## 2. Вход по паролю (новый)

```
┌─────────┐
│ Клиент  │
└────┬────┘
     │
     │ 1. POST /auth/login-password/
     │    {phone_number, password}
     ▼
┌─────────────┐
│   Backend   │
│  - Поиск    │
│    user     │
│  - Проверка │
│    пароля   │
│  - Генерация│
│    JWT      │
└──────┬──────┘
       │
       │ 2. {user, tokens}
       ▼
┌─────────┐
│ Клиент  │──► Сохранение в localStorage
└─────────┘    Переход на /dashboard
```

## 3. Установка пароля (новый)

```
┌─────────┐
│ Клиент  │ (уже авторизован)
└────┬────┘
     │
     │ 1. POST /auth/set-password/
     │    {new_password}
     │    Authorization: Bearer <token>
     ▼
┌─────────────┐
│   Backend   │
│  - Проверка │
│    токена   │
│  - Хеширова-│
│    ние      │
│  - Сохране- │
│    ние      │
└──────┬──────┘
       │
       │ 2. {message, has_password: true}
       ▼
┌─────────┐
│ Клиент  │──► Обновление UI
└─────────┘    "Пароль установлен"
```

## 4. Изменение пароля (новый)

```
┌─────────┐
│ Клиент  │ (уже авторизован)
└────┬────┘
     │
     │ 1. POST /auth/set-password/
     │    {current_password, new_password}
     │    Authorization: Bearer <token>
     ▼
┌─────────────┐
│   Backend   │
│  - Проверка │
│    токена   │
│  - Проверка │
│    текущего │
│    пароля   │
│  - Хеширова-│
│    ние      │
│  - Сохране- │
│    ние      │
└──────┬──────┘
       │
       │ 2. {message, has_password: true}
       ▼
┌─────────┐
│ Клиент  │──► Обновление UI
└─────────┘    "Пароль изменен"
```

## 5. Сброс пароля (новый)

```
┌─────────┐
│ Клиент  │
└────┬────┘
     │
     │ 1. POST /auth/reset-password/request/
     │    {phone_number}
     ▼
┌─────────────┐
│   Backend   │──────► Green-API ──────► WhatsApp
│  - Генерация│                              │
│    OTP      │                              │
└──────┬──────┘                              │
       │                                     │
       │ 2. OTP код сохранен                 │
       │                                     │
       │ ◄───────────────────────────────────┘
       │    Пользователь получает код
       │
       │ 3. POST /auth/reset-password/confirm/
       │    {phone_number, code, new_password}
       ▼
┌─────────────┐
│   Backend   │
│  - Проверка │
│    OTP      │
│  - Хеширова-│
│    ние      │
│  - Сохране- │
│    ние      │
└──────┬──────┘
       │
       │ 4. {message}
       ▼
┌─────────┐
│ Клиент  │──► Переход на форму входа
└─────────┘    "Пароль изменен"
```

## 6. Полный цикл пользователя

```
┌──────────────────────────────────────────────────────────┐
│                    Первый вход                           │
│                                                          │
│  1. Регистрация через WhatsApp OTP                       │
│     ├─► Отправка OTP                                     │
│     ├─► Ввод кода                                        │
│     └─► Создание аккаунта                                │
│                                                          │
│  2. Вход в систему                                       │
│     └─► Переход на /dashboard                            │
│                                                          │
│  3. Установка пароля (опционально)                       │
│     ├─► Открыть настройки                                │
│     ├─► Ввести новый пароль                              │
│     └─► Сохранить                                        │
│                                                          │
└──────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────┐
│                 Последующие входы                        │
│                                                          │
│  Вариант А: WhatsApp OTP                                 │
│  ├─► Отправка кода                                       │
│  ├─► Ввод кода                                           │
│  └─► Вход                                                │
│                                                          │
│  Вариант Б: Пароль (если установлен)                     │
│  ├─► Ввод номера телефона                                │
│  ├─► Ввод пароля                                         │
│  └─► Вход                                                │
│                                                          │
└──────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────┐
│              Управление паролем                          │
│                                                          │
│  Изменение пароля:                                       │
│  ├─► Настройки                                           │
│  ├─► Ввод текущего пароля                                │
│  ├─► Ввод нового пароля                                  │
│  └─► Сохранить                                           │
│                                                          │
│  Сброс пароля (если забыли):                             │
│  ├─► "Забыли пароль?"                                    │
│  ├─► Ввод номера телефона                                │
│  ├─► Получение OTP в WhatsApp                            │
│  ├─► Ввод кода                                           │
│  ├─► Установка нового пароля                             │
│  └─► Вход с новым паролем                                │
│                                                          │
└──────────────────────────────────────────────────────────┘
```

## 7. Архитектура компонентов

```
┌─────────────────────────────────────────────────────────┐
│                      Frontend                           │
│                                                         │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │
│  │ LoginPage    │  │ SettingsPage │  │   Header     │  │
│  │              │  │              │  │              │  │
│  │ - WhatsApp   │  │ - Set Pass   │  │ - Settings   │  │
│  │ - Password   │  │ - Change Pass│  │   Button     │  │
│  │ - Reset Pass │  │              │  │              │  │
│  └──────┬───────┘  └──────┬───────┘  └──────────────┘  │
│         │                 │                             │
│         └─────────┬───────┘                             │
│                   │                                     │
│         ┌─────────▼─────────┐                           │
│         │     api.ts        │                           │
│         │  - authAPI        │                           │
│         └─────────┬─────────┘                           │
│                   │                                     │
│         ┌─────────▼─────────┐                           │
│         │   authStore.ts    │                           │
│         │   userStore.ts    │                           │
│         └───────────────────┘                           │
└─────────────────┬───────────────────────────────────────┘
                  │
                  │ HTTP/JSON
                  │
┌─────────────────▼───────────────────────────────────────┐
│                      Backend                            │
│                                                         │
│  ┌──────────────────────────────────────────────────┐  │
│  │              urls.py (routing)                   │  │
│  └──────────────────┬───────────────────────────────┘  │
│                     │                                   │
│  ┌──────────────────▼───────────────────────────────┐  │
│  │              views.py                            │  │
│  │  - send_otp()                                    │  │
│  │  - verify_otp()                                  │  │
│  │  - login_password()         ◄── NEW              │  │
│  │  - set_password()           ◄── NEW              │  │
│  │  - reset_password_request() ◄── NEW              │  │
│  │  - reset_password_confirm() ◄── NEW              │  │
│  │  - profile()                                     │  │
│  └──────────────────┬───────────────────────────────┘  │
│                     │                                   │
│  ┌──────────────────▼───────────────────────────────┐  │
│  │           serializers.py                         │  │
│  │  - OTPVerifySerializer                           │  │
│  │  - PasswordLoginSerializer  ◄── NEW              │  │
│  │  - SetPasswordSerializer    ◄── NEW              │  │
│  │  - ResetPasswordSerializer  ◄── NEW              │  │
│  └──────────────────┬───────────────────────────────┘  │
│                     │                                   │
│  ┌──────────────────▼───────────────────────────────┐  │
│  │              models.py                           │  │
│  │  - User (AbstractUser)                           │  │
│  │    - phone_number                                │  │
│  │    - password (inherited)                        │  │
│  │    - has_usable_password()                       │  │
│  │  - OTPCode                                       │  │
│  └──────────────────┬───────────────────────────────┘  │
│                     │                                   │
│  ┌──────────────────▼───────────────────────────────┐  │
│  │              services.py                         │  │
│  │  - OTPService                                    │  │
│  │  - GreenAPIService                               │  │
│  └──────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────┘
```

## 8. Состояния пользователя

```
┌─────────────────────────────────────────────────────────┐
│                  Состояния User                         │
│                                                         │
│  ┌──────────────────────────────────────────────────┐  │
│  │  Новый пользователь                              │  │
│  │  - phone_verified: false                         │  │
│  │  - has_usable_password(): false                  │  │
│  └────────────────┬─────────────────────────────────┘  │
│                   │                                     │
│                   │ Вход через WhatsApp OTP             │
│                   ▼                                     │
│  ┌──────────────────────────────────────────────────┐  │
│  │  Зарегистрированный (только WhatsApp)            │  │
│  │  - phone_verified: true                          │  │
│  │  - has_usable_password(): false                  │  │
│  └────────────────┬─────────────────────────────────┘  │
│                   │                                     │
│                   │ Установка пароля                    │
│                   ▼                                     │
│  ┌──────────────────────────────────────────────────┐  │
│  │  Полный доступ (оба метода)                      │  │
│  │  - phone_verified: true                          │  │
│  │  - has_usable_password(): true                   │  │
│  │  - Может входить через WhatsApp                  │  │
│  │  - Может входить через пароль                    │  │
│  └──────────────────────────────────────────────────┘  │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

## 9. Безопасность

```
┌─────────────────────────────────────────────────────────┐
│                  Уровни защиты                          │
│                                                         │
│  1. Транспорт                                           │
│     └─► HTTPS (в продакшене)                            │
│                                                         │
│  2. Аутентификация                                      │
│     ├─► JWT токены                                      │
│     ├─► OTP коды (5 минут)                              │
│     └─► Хеширование паролей (PBKDF2)                    │
│                                                         │
│  3. Авторизация                                         │
│     ├─► Bearer токен в заголовках                       │
│     └─► Проверка прав доступа                           │
│                                                         │
│  4. Валидация                                           │
│     ├─► Минимум 6 символов для пароля                   │
│     ├─► Нормализация номера телефона                    │
│     └─► Проверка текущего пароля при изменении          │
│                                                         │
│  5. Защита от атак                                      │
│     ├─► Одноразовые OTP коды                            │
│     ├─► Истечение токенов                               │
│     └─► Не раскрывается существование пользователя      │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

## Легенда

```
─►  Поток данных
│   Последовательность
▼   Направление вниз
◄── Новая функциональность
```
