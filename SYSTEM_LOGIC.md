# 🏗️ Логика работы системы ProfMed.kz

## ✅ РЕАЛИЗОВАНО: Подписка на организацию

### 📋 Правильный порядок работы системы

#### 1️⃣ РЕГИСТРАЦИЯ И СОЗДАНИЕ ОРГАНИЗАЦИИ

**Работодатель:**
1. ✅ Регистрируется (авторизуется через WhatsApp)
2. ✅ Создает организацию типа "Работодатель"
3. ✅ Запрашивает подписку (выбирает план) → статус: `pending`
4. ⏳ Админ одобряет/активирует подписку → статус: `active`
5. ✅ Работодатель получает доступ к функциям:
   - Добавление сотрудников (автоматически создаются User аккаунты)
   - Генерация документов
   - Создание осмотров
   - Выбор клиники для осмотров

**Клиника:**
1. ✅ Регистрируется (авторизуется через WhatsApp)
2. ✅ Создает организацию типа "Клиника"
3. ✅ Запрашивает подписку (выбирает план) → статус: `pending`
4. ⏳ Админ одобряет/активирует подписку → статус: `active`
5. ✅ Клиника получает доступ к функциям:
   - Регистратура (прием осмотров)
   - АРМ врача
   - Просмотр назначенных осмотров
   - Добавление врачей (автоматически создаются User аккаунты)

---

### 2️⃣ АВТОМАТИЧЕСКОЕ СОЗДАНИЕ ЛИЧНЫХ КАБИНЕТОВ

#### ✅ При добавлении сотрудника (Работодатель):
- Автоматически создается `User` с номером телефона сотрудника
- Создается `Employee` профиль
- Сотрудник может авторизоваться и видеть свои осмотры
- `phone_verified = False` (пока не подтвердил через OTP)

#### ✅ При добавлении врача/регистратора (Клиника):
- Автоматически создается `User` с номером телефона врача
- Создается `OrganizationMember` с ролью (doctor, registrar, profpathologist)
- Врач может авторизоваться и видеть назначенные осмотры
- `phone_verified = False` (пока не подтвердил через OTP)

---

### 3️⃣ СВЯЗЬ МЕЖДУ РАБОТОДАТЕЛЕМ И КЛИНИКОЙ

**Как работодатель выбирает клинику:**
- При создании осмотра работодатель выбирает клинику из списка активных клиник
- Клиника должна быть активной (с подпиской `active`)
- Работодатель может работать с несколькими клиниками

**Как клиника видит осмотры:**
- Клиника видит только осмотры, назначенные в их клинику
- Осмотры появляются автоматически после создания работодателем

---

### 4️⃣ ПРАВИЛЬНАЯ ЛОГИКА ДОСТУПА

```
┌─────────────────────────────────────────────────┐
│ 1. РЕГИСТРАЦИЯ (WhatsApp OTP)                  │
│    → Любой может зарегистрироваться            │
└─────────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────────┐
│ 2. СОЗДАНИЕ ОРГАНИЗАЦИИ                        │
│    → Работодатель создает свою организацию     │
│    → Клиника создает свою организацию          │
└─────────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────────┐
│ 3. ЗАПРОС ПОДПИСКИ                             │
│    → Выбор плана (Базовый/Бизнес/Корпоративный)│
│    → Статус: "pending" (ожидает одобрения)     │
│    → POST /api/subscriptions/subscriptions/request_subscription/
└─────────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────────┐
│ 4. АДМИН ОДОБРЯЕТ ПОДПИСКУ                    │
│    → Статус: "active"                          │
│    → Устанавливает срок действия                │
│    → POST /api/subscriptions/subscriptions/{id}/approve/
└─────────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────────┐
│ 5. ДОСТУП К ФУНКЦИЯМ                          │
│    Работодатель:                               │
│    ✓ Добавление сотрудников (создается User)   │
│    ✓ Генерация документов                      │
│    ✓ Создание осмотров                         │
│    ✓ Выбор клиники                             │
│                                                 │
│    Клиника:                                    │
│    ✓ Регистратура (QR сканирование)            │
│    ✓ АРМ врача                                 │
│    ✓ Просмотр назначенных осмотров             │
│    ✓ Добавление врачей (создается User)        │
└─────────────────────────────────────────────────┘
```

---

### 5️⃣ КТО ЧТО ВИДИТ

**Работодатель (с активной подпиской):**
- ✅ Свои организации (тип: employer)
- ✅ Своих сотрудников
- ✅ Осмотры своих сотрудников
- ✅ Документы своих организаций
- ✅ Список активных клиник (для выбора)

**Клиника (с активной подпиской):**
- ✅ Свои организации (тип: clinic)
- ✅ Осмотры, назначенные в их клинику
- ✅ QR-коды для сканирования
- ✅ Своих врачей и регистраторов
- ❌ НЕ видит сотрудников работодателей
- ❌ НЕ видит документы работодателей

**Пациент (Сотрудник):**
- ✅ Только свои осмотры
- ✅ Свои результаты
- ❌ НЕ видит других сотрудников
- ❌ НЕ видит документы работодателя

**Врач:**
- ✅ Осмотры назначенные в его клинику
- ✅ Может проводить осмотры
- ❌ НЕ видит сотрудников работодателей (только данные осмотра)

---

### 6️⃣ МОДЕЛЬ ПОДПИСКИ

**Подписка привязана к ОРГАНИЗАЦИИ:**

```python
class Subscription:
    organization = OneToOneField(Organization)  # Подписка на организацию
    plan = ForeignKey(SubscriptionPlan)
    status = CharField()  # none, pending, active, expired, cancelled
    approved_by = ForeignKey(User)  # Кто одобрил (админ)
    approved_at = DateTimeField()  # Когда одобрили
    expires_at = DateTimeField()  # Срок действия
```

**Статусы:**
- `none` - Нет подписки (по умолчанию)
- `pending` - Ожидает одобрения админа
- `active` - Активна и работает
- `expired` - Истекла
- `cancelled` - Отменена

---

### 7️⃣ API ЭНДПОИНТЫ

**Подписки:**
- `GET /api/subscriptions/plans/` - Список планов
- `POST /api/subscriptions/subscriptions/request_subscription/` - Запросить подписку
- `GET /api/subscriptions/subscriptions/my_subscriptions/` - Мои подписки
- `POST /api/subscriptions/subscriptions/{id}/approve/` - Одобрить (админ)

**Организации:**
- `POST /api/organizations/organizations/{id}/add_member/` - Добавить врача (создается User)
- `POST /api/organizations/employees/` - Добавить сотрудника (создается User)

---

## ✅ РЕАЛИЗОВАНО

1. ✅ **Подписка на организацию** (не на пользователя)
2. ✅ **Автоматическое создание User** при добавлении сотрудника
3. ✅ **Автоматическое создание User** при добавлении врача
4. ✅ **Middleware проверки подписки** организации
5. ✅ **API для запроса и одобрения подписок**
6. ✅ **Админ-панель** для управления подписками

---

## 📝 СЛЕДУЮЩИЕ ШАГИ

1. ⏳ Создать UI для запроса подписки
2. ⏳ Создать админ-панель для одобрения подписок
3. ⏳ Обновить проверку доступа в views (только организации с активной подпиской)
4. ⏳ Добавить уведомления о статусе подписки
